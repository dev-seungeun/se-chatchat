{"ast":null,"code":"import _asyncToGenerator from\"C:/workspaces/atom_workspace/sesh-chatchat/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"C:/workspaces/atom_workspace/sesh-chatchat/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _regeneratorRuntime from\"C:\\\\workspaces\\\\atom_workspace\\\\sesh-chatchat\\\\node_modules\\\\@babel\\\\runtime\\\\regenerator\\\\index.js\";import React,{useState,useHistory,useEffect,useRef}from\"react\";import{useLocation}from\"react-router-dom\";import{logout}from\"../helpers/auth\";import{authService,database,database_ref}from\"../services/firebase\";import{sendChat,sendChatTime,getChats,getAddedChats,offRef}from\"../helpers/database\";import useNotification from\"../helpers/useNotification\";import\"../chat.css\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";function useQuery(){var _useLocation=useLocation(),search=_useLocation.search;return React.useMemo(function(){return new URLSearchParams(search);},[search]);}function Chat(){var isMount=true;var startAdd=false;var _useState=useState(\"\"),_useState2=_slicedToArray(_useState,2),msg=_useState2[0],setMsg=_useState2[1];var _useState3=useState(\"\"),_useState4=_slicedToArray(_useState3,2),chatList=_useState4[0],setChatList=_useState4[1];var _useState5=useState(\"\"),_useState6=_slicedToArray(_useState5,2),chats=_useState6[0],setChats=_useState6[1];var setChatUI=function setChatUI(chatList,isInitEnd){var themeData=getThemeData();var myList=function myList(){if(themeData.theme==\"light\"){var list=chatList.map(function(chat,index){return/*#__PURE__*/_jsxs(\"li\",{className:chat.uid===authService.currentUser.uid?\"right\":\"left\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"time\",children:/*#__PURE__*/_jsx(\"span\",{children:toDate(chat.timestamp)})},createItem(index+\"time\")),/*#__PURE__*/_jsx(\"div\",{className:\"sender\",children:/*#__PURE__*/_jsx(\"span\",{children:chat.email})},createItem(index+\"sender\")),/*#__PURE__*/_jsx(\"div\",{className:\"message\",children:chat.message.split('\\n').map(function(line){return/*#__PURE__*/_jsxs(\"span\",{children:[line,/*#__PURE__*/_jsx(\"br\",{})]},createItem(index+\"span\"));})},createItem(index+\"message\"))]},createItem(index+\"li\"));});return/*#__PURE__*/_jsx(\"ul\",{children:list});}else{var _list=chatList.map(function(chat,index){return/*#__PURE__*/_jsxs(\"li\",{className:chat.uid===authService.currentUser.uid?\"right\":\"left\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"sender\",children:/*#__PURE__*/_jsx(\"span\",{children:\"C:\\\\Users\\\\\"+chat.email})},createItem(index+\"sender\")),/*#__PURE__*/_jsx(\"div\",{className:\"time\",children:/*#__PURE__*/_jsx(\"span\",{children:toDate(chat.timestamp)+\" >\"})},createItem(index+\"time\")),/*#__PURE__*/_jsx(\"div\",{className:\"message\",children:chat.message.split('\\n').map(function(line){return/*#__PURE__*/_jsxs(\"span\",{children:[line,/*#__PURE__*/_jsx(\"br\",{})]},createItem(index+\"span\"));})},createItem(index+\"message\"))]},createItem(index+\"li\"));});return/*#__PURE__*/_jsx(\"ul\",{children:_list});}};setChats(myList);setChatList(chatList);var focused=document.hasFocus();if(!focused&&startAdd&&isMount){notify(chatList);}if(isInitEnd)startAdd=true;isMount&&setTimeout(function(){scrollToBottom();},200);};var getThemeData=function getThemeData(){if(isMount){var chatWrap=document.querySelector(\".chat_wrap\");var theme=chatWrap.getAttribute(\"data-theme\");return{'chatWrap':chatWrap,'theme':theme};}};var notify=function notify(chatList){if(chatList.length>0){var chat=chatList[chatList.length-1];if(chat.uid!==authService.currentUser.uid){useNotification('SESH',{body:\"from '\"+roomName+\"''\"});// useNotification(chat.email, {\n//   body: `${chat.message}`\n// });\n}}};var sendMsg=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(e,msg){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(msg.trim()!==\"\")){_context.next=10;break;}_context.prev=1;_context.next=4;return sendChat(roomName,{uid:authService.currentUser.uid,email:authService.currentUser.email,message:msg,timestamp:Date.now()}).then(function(){setMsg(\"\");});case 4:sendChatTime(roomName,authService.currentUser.uid);_context.next=10;break;case 7:_context.prev=7;_context.t0=_context[\"catch\"](1);console.log(_context.t0);case 10:case\"end\":return _context.stop();}}},_callee,null,[[1,7]]);}));return function sendMsg(_x,_x2){return _ref.apply(this,arguments);};}();// USE EFFECT  ---------------------------------------\nuseEffect(function(){getAddedChats(roomName,setChatUI);return function(){isMount=false;};},[]);// HANDLE  -------------------------------------------\nvar handleSendMsg=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(e){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:sendMsg(e,msg);case 1:case\"end\":return _context2.stop();}}},_callee2);}));return function handleSendMsg(_x3){return _ref2.apply(this,arguments);};}();var handleLogOut=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.prev=0;_context3.next=3;return logout();case 3:_context3.next=8;break;case 5:_context3.prev=5;_context3.t0=_context3[\"catch\"](0);console.log(_context3.t0);case 8:case\"end\":return _context3.stop();}}},_callee3,null,[[0,5]]);}));return function handleLogOut(){return _ref3.apply(this,arguments);};}();var handleOnChange=function handleOnChange(e){setMsg(e.target.value);};var handleKeyPress=/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(e){return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:if(e.key=='Enter'){if(!e.shiftKey){sendMsg(e,msg);}}case 1:case\"end\":return _context4.stop();}}},_callee4);}));return function handleKeyPress(_x4){return _ref4.apply(this,arguments);};}();var handleTheme=function handleTheme(e){var modeBtn=document.getElementById(\"modeBtn\");var themeData=getThemeData();var chatWrap=themeData.chatWrap;var theme=themeData.theme;if(theme==\"light\"){chatWrap.removeAttribute(\"data-theme\",\"light\");chatWrap.setAttribute(\"data-theme\",\"dark\");modeBtn.innerText=\"LIGHT\";}else{chatWrap.removeAttribute(\"data-theme\",\"dark\");chatWrap.setAttribute(\"data-theme\",\"light\");modeBtn.innerText=\"DARK\";}setChatUI(chatList);};// ETC ----------------------------------------------\nvar query=useQuery();var roomName=query.get(\"room\");var messageRef=useRef();var scrollToBottom=function scrollToBottom(){messageRef.current.scrollIntoView({behavior:'smooth',block:'end'});};var itemId=1;var createItem=function createItem(text){return itemId++ +text;};var toDate=function toDate(timestamp){//let date = new Intl.DateTimeFormat('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' }).format(timestamp);\nvar date=new Intl.DateTimeFormat('ko-KR',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}).format(timestamp);return date;};// --------------------------------------------------\nreturn/*#__PURE__*/_jsxs(\"div\",{className:\"chat_wrap\",\"data-theme\":\"light\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"header\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"mode\",type:\"button\",id:\"modeBtn\",value:\"\",onClick:handleTheme,children:\"DARK\"}),/*#__PURE__*/_jsx(\"div\",{className:\"title\",children:roomName}),/*#__PURE__*/_jsx(\"button\",{className:\"logout\",type:\"button\",onClick:handleLogOut,children:\"LOGOUT\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"chat\",children:[chats,/*#__PURE__*/_jsx(\"div\",{ref:messageRef})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"input-div\",onKeyPress:handleKeyPress,children:[/*#__PURE__*/_jsx(\"textarea\",{className:\"input-msg\",value:msg,placeholder:\"Message Here.\",onChange:handleOnChange}),/*#__PURE__*/_jsx(\"button\",{className:\"send\",type:\"button\",onClick:handleSendMsg,children:\"SEND\"})]})]});}export default Chat;","map":{"version":3,"sources":["C:/workspaces/atom_workspace/sesh-chatchat/src/pages/Chat.js"],"names":["React","useState","useHistory","useEffect","useRef","useLocation","logout","authService","database","database_ref","sendChat","sendChatTime","getChats","getAddedChats","offRef","useNotification","useQuery","search","useMemo","URLSearchParams","Chat","isMount","startAdd","msg","setMsg","chatList","setChatList","chats","setChats","setChatUI","isInitEnd","themeData","getThemeData","myList","theme","list","map","chat","index","uid","currentUser","toDate","timestamp","createItem","email","message","split","line","focused","document","hasFocus","notify","setTimeout","scrollToBottom","chatWrap","querySelector","getAttribute","length","body","roomName","sendMsg","e","trim","Date","now","then","console","log","handleSendMsg","handleLogOut","handleOnChange","target","value","handleKeyPress","key","shiftKey","handleTheme","modeBtn","getElementById","removeAttribute","setAttribute","innerText","query","get","messageRef","current","scrollIntoView","behavior","block","itemId","text","date","Intl","DateTimeFormat","hour","minute","second","hour12","format"],"mappings":"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","sourcesContent":["import React, { useState, useHistory, useEffect, useRef } from \"react\";\r\nimport { useLocation } from \"react-router-dom\";\r\nimport { logout } from \"../helpers/auth\";\r\nimport { authService, database, database_ref } from \"../services/firebase\";\r\nimport { sendChat, sendChatTime, getChats, getAddedChats, offRef } from \"../helpers/database\";\r\nimport useNotification from \"../helpers/useNotification\";\r\nimport \"../chat.css\";\r\n\r\nfunction useQuery() {\r\n  const { search } = useLocation();\r\n  return React.useMemo(() => new URLSearchParams(search), [search]);\r\n}\r\n\r\nfunction Chat() {\r\n\r\n  let isMount = true;\r\n  let startAdd = false;\r\n  const [msg, setMsg] = useState(\"\");\r\n  const [chatList, setChatList] = useState(\"\");\r\n  const [chats, setChats] = useState(\"\");\r\n\r\n  const setChatUI = (chatList, isInitEnd) => {\r\n    const themeData = getThemeData();\r\n    const myList = () => {\r\n      if(themeData.theme == \"light\") {\r\n        const list = chatList.map((chat, index) => (\r\n          <li key={createItem(index+\"li\")} className={chat.uid === authService.currentUser.uid ? \"right\" : \"left\"}>\r\n            <div key={createItem(index+\"time\")} className = \"time\"><span>{toDate(chat.timestamp)}</span></div>\r\n            <div key={createItem(index+\"sender\")} className = \"sender\"><span>{chat.email}</span></div>\r\n            <div key={createItem(index+\"message\")} className = \"message\">\r\n              {chat.message.split('\\n').map( line => {\r\n                return (<span key={createItem(index+\"span\")}>{line}<br/></span>)\r\n               })}\r\n            </div>\r\n          </li>\r\n        ));\r\n        return <ul>{list}</ul>;\r\n      }else {\r\n        const list = chatList.map((chat, index) => (\r\n          <li key={createItem(index+\"li\")} className={chat.uid === authService.currentUser.uid ? \"right\" : \"left\"}>\r\n            <div key={createItem(index+\"sender\")} className = \"sender\"><span>{\"C:\\\\Users\\\\\"+chat.email}</span></div>\r\n            <div key={createItem(index+\"time\")} className = \"time\"><span>{toDate(chat.timestamp)+\" >\"}</span></div>\r\n            <div key={createItem(index+\"message\")} className = \"message\">\r\n              {chat.message.split('\\n').map( line => {\r\n                return (<span key={createItem(index+\"span\")}>{line}<br/></span>)\r\n               })}\r\n            </div>\r\n          </li>\r\n        ));\r\n        return <ul>{list}</ul>;\r\n      }\r\n    }\r\n    setChats(myList);\r\n    setChatList(chatList);\r\n\r\n    const focused = document.hasFocus();\r\n    if(!focused && startAdd && isMount) {\r\n      notify(chatList);\r\n    }\r\n    if(isInitEnd) startAdd = true;\r\n\r\n    isMount && setTimeout(()=>{ scrollToBottom() }, 200);\r\n\r\n  };\r\n\r\n  const getThemeData = () => {\r\n    if(isMount) {\r\n      const chatWrap = document.querySelector(\".chat_wrap\")\r\n      const theme = chatWrap.getAttribute(\"data-theme\");\r\n      return {'chatWrap': chatWrap, 'theme': theme};\r\n    }\r\n  };\r\n\r\n  const notify = (chatList) => {\r\n    if(chatList.length > 0) {\r\n      const chat = chatList[chatList.length-1];\r\n      if(chat.uid !== authService.currentUser.uid) {\r\n        useNotification('SESH', {\r\n          body: \"from '\"+roomName+\"''\"\r\n        });\r\n        // useNotification(chat.email, {\r\n        //   body: `${chat.message}`\r\n        // });\r\n      }\r\n    }\r\n  }\r\n\r\n  const sendMsg = async (e, msg) => {\r\n    if(msg.trim() !== \"\") {\r\n      try {\r\n\r\n        await sendChat(roomName,\r\n        {\r\n          uid: authService.currentUser.uid,\r\n          email: authService.currentUser.email,\r\n          message: msg,\r\n          timestamp: Date.now()\r\n        }).then(() => {\r\n          setMsg(\"\");\r\n        });\r\n\r\n        sendChatTime(roomName, authService.currentUser.uid);\r\n\r\n      } catch (error) {\r\n        console.log(error);\r\n      }\r\n    }\r\n  }\r\n\r\n// USE EFFECT  ---------------------------------------\r\n  useEffect(() => {\r\n    getAddedChats(roomName, setChatUI);\r\n    return() => {\r\n      isMount = false;\r\n    }\r\n  }, []);\r\n\r\n\r\n// HANDLE  -------------------------------------------\r\n  const handleSendMsg = async (e) => {\r\n    sendMsg(e, msg);\r\n  };\r\n\r\n  const handleLogOut = async () => {\r\n    try {\r\n      await logout();\r\n    } catch (error) {\r\n     console.log(error);\r\n    }\r\n  };\r\n\r\n  const handleOnChange = (e) => {\r\n    setMsg(e.target.value);\r\n  };\r\n\r\n\r\n  const handleKeyPress = async(e) => {\r\n    if(e.key == 'Enter') {\r\n      if(!e.shiftKey) {\r\n        sendMsg(e, msg);\r\n      }\r\n    }\r\n  }\r\n\r\n\r\n  const handleTheme = (e) => {\r\n    const modeBtn = document.getElementById(\"modeBtn\");\r\n    const themeData = getThemeData();\r\n    const chatWrap = themeData.chatWrap;\r\n    const theme = themeData.theme;\r\n    if(theme == \"light\") {\r\n      chatWrap.removeAttribute(\"data-theme\", \"light\")\r\n      chatWrap.setAttribute(\"data-theme\", \"dark\")\r\n      modeBtn.innerText = \"LIGHT\"\r\n    }else {\r\n      chatWrap.removeAttribute(\"data-theme\", \"dark\")\r\n      chatWrap.setAttribute(\"data-theme\", \"light\")\r\n      modeBtn.innerText = \"DARK\"\r\n    }\r\n    setChatUI(chatList);\r\n  }\r\n\r\n\r\n// ETC ----------------------------------------------\r\n  let query = useQuery();\r\n  const roomName = query.get(\"room\")\r\n\r\n  const messageRef = useRef();\r\n  const scrollToBottom = () => {\r\n    messageRef.current.scrollIntoView({ behavior: 'smooth', block: 'end' })\r\n  }\r\n\r\n  let itemId = 1;\r\n  const createItem = (text) => {\r\n    return (itemId++) + text;\r\n  }\r\n\r\n  const toDate = (timestamp) => {\r\n    //let date = new Intl.DateTimeFormat('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' }).format(timestamp);\r\n    let date = new Intl.DateTimeFormat('ko-KR', {  hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }).format(timestamp);\r\n    return date;\r\n  }\r\n// --------------------------------------------------\r\n\r\n  return (\r\n\r\n    <div className=\"chat_wrap\" data-theme=\"light\">\r\n      <div className=\"header\">\r\n        <button\r\n          className=\"mode\"\r\n          type=\"button\"\r\n          id=\"modeBtn\"\r\n          value=\"\"\r\n          onClick={handleTheme}>\r\n          DARK\r\n        </button>\r\n        <div className=\"title\">{roomName}</div>\r\n        <button\r\n          className=\"logout\"\r\n          type=\"button\"\r\n          onClick={handleLogOut}>\r\n          LOGOUT\r\n        </button>\r\n      </div>\r\n      <div className=\"chat\">\r\n        {chats}\r\n        <div ref={messageRef} />\r\n      </div>\r\n      <div className=\"input-div\" onKeyPress={handleKeyPress}>\r\n        <textarea\r\n          className=\"input-msg\"\r\n          value={msg}\r\n          placeholder=\"Message Here.\"\r\n          onChange={handleOnChange}>\r\n        </textarea>\r\n        <button\r\n          className=\"send\"\r\n          type=\"button\"\r\n          onClick={handleSendMsg}>\r\n          SEND\r\n        </button>\r\n      </div>\r\n    </div>\r\n\r\n  );\r\n}\r\n\r\nexport default Chat;\r\n"]},"metadata":{},"sourceType":"module"}